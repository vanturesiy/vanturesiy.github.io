var Mustache=function(){var e={},t=function(){};return t.prototype={otag:"{{",ctag:"}}",pragmas:{},buffer:[],pragmas_implemented:{"IMPLICIT-ITERATOR":!0},context:{},render:function(e,t,n,r){if(r||(this.context=t,this.buffer=[]),!this.includes("",e))return r?e:void this.send(e);e=this.render_pragmas(e);var i=this.render_section(e,t,n);return i===!1&&(i=this.render_tags(e,t,n,r)),r?i:void this.sendLines(i)},send:function(e){""!==e&&this.buffer.push(e)},sendLines:function(e){if(e)for(var t=e.split("\n"),n=0;n<t.length;n++)this.send(t[n])},render_pragmas:function(e){if(!this.includes("%",e))return e;var t=this,n=this.getCachedRegex("render_pragmas",function(e,t){return new RegExp(e+"%([\\w-]+) ?([\\w]+=[\\w]+)?"+t,"g")});return e.replace(n,function(e,n,r){if(!t.pragmas_implemented[n])throw{message:"This implementation of mustache doesn't understand the '"+n+"' pragma"};if(t.pragmas[n]={},r){var i=r.split("=");t.pragmas[n][i[0]]=i[1]}return""})},render_partial:function(e,t,n){if(e=this.trim(e),!n||void 0===n[e])throw{message:"unknown_partial '"+e+"'"};return"object"!=typeof t[e]?this.render(n[e],t,n,!0):this.render(n[e],t[e],n,!0)},render_section:function(e,t,n){if(!this.includes("#",e)&&!this.includes("^",e))return!1;var r=this,i=this.getCachedRegex("render_section",function(e,t){return new RegExp("^([\\s\\S]*?)"+e+"(\\^|\\#)\\s*(.+)\\s*"+t+"\n*([\\s\\S]*?)"+e+"\\/\\s*\\3\\s*"+t+"\\s*([\\s\\S]*)$","g")});return e.replace(i,function(e,i,a,o,s,u){var c,l=i?r.render_tags(i,t,n,!0):"",h=u?r.render(u,t,n,!0):"",d=r.find(o,t);return"^"===a?c=!d||r.is_array(d)&&0===d.length?r.render(s,t,n,!0):"":"#"===a&&(c=r.is_array(d)?r.map(d,function(e){return r.render(s,r.create_context(e),n,!0)}).join(""):r.is_object(d)?r.render(s,r.create_context(d),n,!0):"function"==typeof d?d.call(t,s,function(e){return r.render(e,t,n,!0)}):d?r.render(s,t,n,!0):""),l+c+h})},render_tags:function(e,t,n,r){for(var i=this,a=function(){return i.getCachedRegex("render_tags",function(e,t){return new RegExp(e+"(=|!|>|\\{|%)?([^\\/#\\^]+?)\\1?"+t+"+","g")})},o=a(),s=function(e,r,s){switch(r){case"!":return"";case"=":return i.set_delimiters(s),o=a(),"";case">":return i.render_partial(s,t,n);case"{":return i.find(s,t);default:return i.escape(i.find(s,t))}},u=e.split("\n"),c=0;c<u.length;c++)u[c]=u[c].replace(o,s,this),r||this.send(u[c]);if(r)return u.join("\n")},set_delimiters:function(e){var t=e.split(" ");this.otag=this.escape_regex(t[0]),this.ctag=this.escape_regex(t[1])},escape_regex:function(e){if(!arguments.callee.sRE){var t=["/",".","*","+","?","|","(",")","[","]","{","}","\\"];arguments.callee.sRE=new RegExp("(\\"+t.join("|\\")+")","g")}return e.replace(arguments.callee.sRE,"\\$1")},find:function(e,t){function n(e){return e===!1||0===e||e}e=this.trim(e);var r;if(e.match(/([a-z_]+)\./gi)){var i=this.walk_context(e,t);n(i)&&(r=i)}else n(t[e])?r=t[e]:n(this.context[e])&&(r=this.context[e]);return"function"==typeof r?r.apply(t):void 0!==r?r:""},walk_context:function(e,t){for(var n=e.split("."),r=void 0!=t[n[0]]?t:this.context,i=r[n.shift()];void 0!=i&&n.length>0;)r=i,i=i[n.shift()];return"function"==typeof i?i.apply(r):i},includes:function(e,t){return t.indexOf(this.otag+e)!=-1},escape:function(e){return e=String(null===e?"":e),e.replace(/&(?!\w+;)|["'<>\\]/g,function(e){switch(e){case"&":return"&amp;";case'"':return"&quot;";case"'":return"&#39;";case"<":return"&lt;";case">":return"&gt;";default:return e}})},create_context:function(e){if(this.is_object(e))return e;var t=".";this.pragmas["IMPLICIT-ITERATOR"]&&(t=this.pragmas["IMPLICIT-ITERATOR"].iterator);var n={};return n[t]=e,n},is_object:function(e){return e&&"object"==typeof e},is_array:function(e){return"[object Array]"===Object.prototype.toString.call(e)},trim:function(e){return e.replace(/^\s*|\s*$/g,"")},map:function(e,t){if("function"==typeof e.map)return e.map(t);for(var n=[],r=e.length,i=0;i<r;i++)n.push(t(e[i]));return n},getCachedRegex:function(t,n){var r=e[this.otag];r||(r=e[this.otag]={});var i=r[this.ctag];i||(i=r[this.ctag]={});var a=i[t];return a||(a=i[t]=n(this.otag,this.ctag)),a}},{name:"mustache.js",version:"0.4.0-dev",to_html:function(e,n,r,i){var a=new t;if(i&&(a.send=i),a.render(e,n||{},r),!i)return a.buffer.join("\n")}}}();Array.prototype.indexOf=Array.prototype.indexOf||function(e){for(var t=-1,n=0,r=this.length;n<r;n++)if(this[n]===e)return n;return t},String.prototype.lastChar=function(){return this.charAt(this.length-1)},function(e){function t(e){return e.replace(p,"")}function n(t){n=null;var r={position:"absolute",left:-9999,width:t.width()+"px","font-family":t.css("font-family"),"font-size":t.css("font-size"),"word-wrap":"break-word",border:"1px"};s=e("<pre></pre>").css(r).appendTo("body")}function r(e,t){var n=this;return n.elem=e,n.options=t,n.tagged={},n.init(t),n}function a(e,t){e&&u.html(e),u.css(t).show()}function o(){u.hide()}var s,u,c=0,l='<div id="db-tagsug-list" class="suggest-overlay"></div>',h=e(document.body),d=/ /g,g=/</g,f=/>/g,p=/<(\/|\\\/)?b>/g,m=/(\\|\+|\:|\*|\/|\||\$|\?|\^|\[|\]|\(|\)|\.)/g,v=e.browser.version<7?"&nbsp;":"x",_=e.browser.msie&&e.browser.version<9,y={highlight:function(t,n,r){r=r||"@";var i=[];for(var a in t)i.push([a,t[a].uid]);return i.sort(function(e,t){return e[0].length<t[0].length}),e.each(i,function(e,t){var i=t[0],a=t[1];_&&(i=i.replace(d,"&nbsp;")),n=n.replace(new RegExp(r+i.replace(m,"\\$1"),"g"),'<code data-id="'+a+'">'+r+i+"</code>")}),n},escape_html:function(e){return e.replace(g,"&lt;").replace(f,"&gt;")},moveSelectedItem:function(t,n){var r=u.find("li"),i=r.length;i&&(n||(n=u.find(".on").index(),n+=t,n>=i&&(n-=i),n<0&&(n===-2&&(n=-1),n+=i)),r.removeClass("on"),e(r[n]).addClass("on").find("a"))},getCursorPosition:function(e){if(document.selection){var t=e.value,n=e._saved_range||document.selection.createRange(),r=e.createTextRange(),i=r.duplicate();if(i.moveToBookmark(n.getBookmark()),r.setEndPoint("EndToStart",i),null==n||null==r)return t.length;var a=n.text.replace(/[\r\n]/g,"."),o=t.replace(/[\r\n]/g,".");return o.indexOf(a,r.text.length)}return e.selectionStart},setCursorPosition:function(e,t){this.selectRangeText(e,t,t)},selectRangeText:function(e,t,n){if(document.selection){var r=e.createTextRange();r.moveEnd("character",-e.value.length),r.moveEnd("character",n),r.moveStart("character",t),r.select()}else e.focus(),e.setSelectionRange(t,n)}};r.prototype={on:function(e,t){var n=this;e+=n.uuid,n.node.bind(e,function(e,r){r=[e].concat(r),t.apply(n,r)})},emit:function(e){var t=arguments;e+=this.uuid,data=Array.prototype.slice.call(t,1),this.node.trigger(e,data)},init:function(t){c++;var n=this;n.url=t.url,t.max&&(n.url=n.url.replace("{max}",t.max));var r=n.elem,i=e(r),a=!0;n.uuid=e.uuid++,n.node=i,i.bind("keyup input propertychange",function(e){if("propertychange"!=e.type||"value"===e.originalEvent.propertyName){var t=this;if(t._closed)return n.clearHighligher();var r=!e.keyCode;if(r&&!t._from_change)return void(t._from_change=!0);r?t._from_change=!0:t._from_change=!1;var i=n._slices=n.slices(),o=i[0],s=i[4],l=o.indexOf(n.options.leadChar)<0,h=l&&n._highlighted||!l&&a;if(s<o.length+1&&h&&n.updateHighlight(),!l&&(r||[38,40,13,16,9,27].indexOf(e.keyCode)<0)&&(n.options.delay?(n.clearTimeout(),n._t_query=setTimeout(function(){i=n._slices=n.slices(),n.query(i)},n.options.delay)):n.query(i)),l?(setTimeout(function(){c||n.hideSug()},200),c--):c++,!r){var d=9===e.keyCode||13===e.keyCode,g=u&&u.find(".on"),f=g.length&&u.is(":visible");d&&f&&n.choose(g,i)}}}),i.bind("keydown",function(e){var t=e.keyCode,i=[16,17,18,20,27,33,34,35,36,37,38,39,40,144].indexOf(t)>-1;if(a=!(i||(e.ctrlKey||e.metaKey)&&65===t||e.shiftKey&&(37===t||39===t)),8==t){var o=n.slices(),s=o[2];s&&s in n.tagged&&(r.value=o[1]+o[3],--n.tagged[s].count<=0&&delete n.tagged[s],n.setCursor(o[4]-s.length-1),e.preventDefault()),n.hideSug()}}),i[0]._sug_ev_binded||(i.bind("keydown",function(e){if(u&&u.is(":visible"))switch(e.keyCode){case 27:n.hideSug(),e.preventDefault(),e.stopPropagation();break;case 38:e.preventDefault(),y.moveSelectedItem(-1);break;case 40:e.preventDefault(),y.moveSelectedItem(1);break;case 9:e.preventDefault();break;case 32:if(n.options.queryIncludingSpace)break;case 13:var t=u.find("li.on").find("a")[0];t&&!t.id&&t.href&&(e.preventDefault(),t.click())}}),i[0]._sug_ev_binded=!0)},clearTimeout:function(){try{clearTimeout(this._t_query)}catch(e){}},slices:function(){var e=this,t=e.elem,n=t.value,r=e.getCursor(),a=n.slice(0,r),o=n.slice(r),s=a.lastIndexOf(this.options.leadChar);if(s<0)return[n,a,null,o,r];if(""===this.options.leadChar){var u=!1;for(i in this.options.hideChar)n.indexOf(this.options.hideChar[i])>-1&&(u=!0);return u?[n,a,"",o,r]:[n,a,a,o,r]}var c=a.slice(0,s),l=a.slice(s+1);return[n,c,l,o,r]},getCursor:function(){return y.getCursorPosition(this.elem)},setCursor:function(e){return y.setCursorPosition(this.elem,e)},updateHighlight:function(){var t=this;if(t.options.highlight){var n=t.elem,r=y.escape_html(n.value);_&&(r=r.replace(d,v));var i=y.highlight(t.tagged,r,t.options.leadChar);i!=r?t._highlighted=!0:t._highlighted=!1;var a=e(t.options.highlighter);a.html(i),a.css("marginTop",-n.scrollTop)}},cleanVal:function(e){var t,n=e||"",r=this.tagged,i=[];for(t in r)i.push(t.replace(m,"\\$1"));return i.length?(i.sort(function(e,t){return e.length<t.length}),i=i.join("|"),n=n.replace(new RegExp("@("+i+")","g"),function(e,t){return"@"+r[t].uid})):n},choose:function(n,r){var i=this;i.hideSug();var a=i.elem;a.value;n||(n=u.find(".on")),r||(r=i._slices||i.slices());var o=r[2]||"",s=t(n.attr("data-id")||n.attr("id"));if(s){var c=s;i.options.useUid||(c=e.trim(n.find(".username").text()),(c.indexOf(i.options.leadChar)>-1||u.text().split(c+"(").length>3)&&(c=s)),i.emit("choose",c,s);var l,h=this.tagged;(l=h[c])?l.count++:h[c]={uid:t(s),count:1},a.value=r[1]+i.options.leadChar+c+" "+r[3];var d=r[4]-o.length+c.length+1;i.setCursor(d),i.updateHighlight()}},showSug:function(e){var t=this;if(!e)return t.hideSug(),t;"_autocomplete"in t&&(t._autocomplete=t.node.attr("autocomplete")),t.node.attr("autocomplete","off");var n="string"==typeof e?'<div class="bd">'+e+"</div>":Mustache.to_html(this.options.listTmpl||"",e);return u.crtApi=this,t.emit("show",e),a(n,t.getSugPos()),u.find("li").hasClass("on")||u.find("li:first").addClass("on"),t},hideSug:function(){var e=this;return e.node.attr("autocomplete",e._autocomplete),e.emit("hide"),o(),e},query:function(n){var r=this,i=r.options;r.elem;n||(n=r.slices());var a=(n[0],n[2]);r._anterior_txt=n[1]+(a||"");var o=i.customData,s=(i.mode,i.max),u=(i.listTmpl,i.arrName);if(null===a||a.length>r.options.wordLimit)return r.hideSug();if(!this.options.queryIncludingSpace&&a.indexOf(" ")>-1)return r.hideSug();if(this.options.queryIncludingSpace&&""===e.trim(a))return r.hideSug();if("function"==typeof o&&(o=o()),""===a){var c=o&&o[u];return c&&c.length?r.showSug(o):r.showSug(r.options.tips)}return o&&(o.q=a),r.url?(r.emit("query",a),r._ajax&&r._ajax.abort(),void(r._ajax=e.getJSON(r.url+encodeURIComponent(a),function(n){n||(n={}),n[u]||(n[u]=[]);var o=n[u],c=o[0],l={};return c&&(c.uid||c.id)&&e.each(o,function(e,n){var r=n.id=n.id||t(n.uid);r&&(l[r]=1)}),o.length<s&&"function"==typeof i.customData&&(o=n[u]=o.concat(i.customData(a,s-o.length,l)[u])),o.length?void r.showSug(n):r.hideSug()}))):r.showSug(o)},getSugPos:function(){var t=this,r=t._anterior_txt;r=y.escape_html(r);var i=e(t.elem);nodePos=i.offset(),dot=e("<em>&nbsp;</em>"),pos={},n&&n(i),_&&(r=r.replace(d,v)),s.html(r).append(dot),pos=dot.position(),t.options.alignLeft&&(pos.left=0,pos.top=2);var a=t.options.sugOffset;return{marginLeft:i.css("paddingLeft"),marginTop:i.css("paddingTop"),top:pos.top+nodePos.top+a.top,left:pos.left+nodePos.left+a.left}}};var x={mode:"complete",wordLimit:8,url:"https://api.douban.com/shuo/in/complete?alt=xd&count={max}&callback=?&word=",max:10,delay:200,customData:null,highlight:!1,highlighter:".tag-sug-hi",sugOffset:{top:21,left:-2},listTmpl:'<ul class="{{cls}}">{{#users}}<li data-id="{{{uid}}}"><a href="http://www.douban.com/people/{{id}}"><img src="{{{avatar}}}"><em class="username">{{{username}}}</em>({{{uid}}})</a></li>{{/users}}</ul>',arrName:"users",leadChar:"@",hideChar:[],queryIncludingSpace:!1,haltLink:!0,alignLeft:!1,tips:"@某人,&nbsp;他能收到你的消息"};e.fn.tagsug=function(t){var n=e.extend({},x,t);n.highlighter!=x.highlighter&&(n.highlight=!0);var i=this,a=[];return i.each(function(){var e=new r(this,n);a.push(e)}),i._tagsug_api=a,b&&b(),i};var b=function(){u=e("#db-tagsug-list"),u.length||(u=e(l).appendTo(h).hide()),u.delegate("li","click",function(t){var n=u.crtApi;n&&n.choose(e(t.currentTarget))}).delegate("li","hover",function(t){e(t.currentTarget).parent().children(".on").removeClass("on").end().end().toggleClass("on")}).delegate("a","click",function(e){var t=u.crtApi;t&&t.options.haltLink&&e.preventDefault()}).click(function(e){u.hide()}),b=null};e.TagSug=r}(jQuery);
