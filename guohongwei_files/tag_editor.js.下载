!function(t){var e={delimeter:/[,，]/,count_limit:5,max_letters:40,warn:{count_limit:"最多只能添加5个标签哦！",max_letters:"单个标签超过字数限制"},tag_tmpl:'<span class="tag"><i>{{tag}}</i><a href="#">X</a></span>'},i={COMMA:44,COMMA_ZH:65292,BACKSPACE:8,SPACE:32,END:35,HOME:36,LEFT:37,RIGHT:39,A:65},n={getCharcode:function(t){var e=t.charCode;return"number"==typeof e&&0!==e?e:t.keyCode},getStrLength:function(e){var i=0;return t(e.split("")).each(function(t,e){i+=e.charCodeAt(0)>0&&e.charCodeAt(0)<128?1:2}),i},getCaretPos:function(t){return"selectionStart"in t?t.selectionStart:Math.abs(document.selection.createRange().moveStart("character",-t.value.length))},setCaretPos:function(t,e){t.setSelectionRange?t.setSelectionRange(e,e):t.createTextRange&&t.createTextRange().move("character",e),t.focus()},getCaretText:function(t,e){var i=n.getCaretPos(t);if(i)return t.value.substring(i-e,i)}},r=function(t){this.text=t,this.node=null};r.prototype={constructor:r,build:function(e,i,n){this.node=[t.fn.insertAfter,t.fn.insertBefore]["after"===i?0:1].call(t(e.replace("{{tag}}",this.text)),n)},editable:function(t){t.tag_writer.addClass("small-tags-writer").width(this.node.outerWidth()).insertBefore(this.node),t.tag_input.val(this.text).focus()}};var a=function(e,i){this.taglist=[],this.dom={tag_editor:t(".tags-editor",e),tag_writer:t(".tags-writer",e),tag_input:t('input[type="text"]',e)},this.options=i,this._events=t({}),this.init(this.dom)};a.prototype={constructor:a,insert:function(e,i){e=t.trim(e);var a=this.indexOf(e);if(0===e.length)return!1;if(a>-1)return this.fire("error",{type:"exist",msg:a}),!1;if(this.taglist.length===this.options.count_limit)return this.fire("error",{msg:this.options.warn.count_limit}),!1;if(n.getStrLength(e)>this.options.max_letters)return this.fire("error",{msg:this.options.warn.max_letters}),!1;var s=new r(e);return s.build(this.options.tag_tmpl,i,this.dom.tag_writer),this.taglist.push(s),this.fire("change"),!0},indexOf:function(e){var i=-1;return t(this.taglist).each(function(t,n){if(n.text.toLowerCase()===e.toLowerCase())return i=t,!1}),i},getTag:function(e){var i=-1;return t(this.taglist).each(function(t,n){if(n.node[0]===e[0])return i=t,!1}),i},get:function(t){return this.taglist[t>=0?t:this.taglist.length+t]},remove:function(e){this.taglist=t.grep(this.taglist,function(t){return t.text===e&&t.node.remove(),t.text!==e}),this.fire("change")},removeAllTags:function(){t(this.taglist).each(function(t,e){e.node.remove()}),this.taglist=[],this.fire("change")},renderFromString:function(e){var i=this,n=!0;return t(e.split(this.options.delimeter)).each(function(t,e){e&&(n=n&&i.insert(e))}),n},_handleInputBreak:function(){var t=this,e=t.dom;""!==e.tag_input.val()&&(t.renderFromString(e.tag_input.val()),e.tag_input.val("")),t.updateOrder(),e.tag_writer.removeClass("small-tags-writer").css("width","auto"),t.get(-1)&&e.tag_writer.insertAfter(t.get(-1).node)},plainString:function(){var e=Array.prototype.slice;return this._handleInputBreak(),t(e.call(this.taglist,e.call(arguments,1))).map(function(t,e){return e.text}).get().join(",")},updateOrder:function(){var e=t(".tag",this.dom.tag_editor);this.taglist.sort(function(t,i){return e.index(t.node)>e.index(i.node)?1:-1})},resize:function(t){t=t||this.dom.tag_input.val().length+2+"em",this.dom.tag_writer.width(t)},on:function(){return this._events.bind.apply(this._events,arguments),this},fire:function(){this._events.trigger.apply(this._events,arguments)},init:function(e){var r=this;this.renderFromString(e.tag_input.val()),e.tag_input.val(""),e.tag_input.bind("focus",function(){e.tag_editor.addClass("focus")}).bind("blur",function(){e.tag_editor.removeClass("focus"),r._handleInputBreak()}),e.tag_input.keyup(function(){var t,a=e.tag_input.val(),s=n.getCaretText(e.tag_input[0],1);s=s&&s.charCodeAt(0),s===i.SPACE&&(t=n.getCaretText(e.tag_input[0],a.length),r.renderFromString(t)&&e.tag_input.val(a.substring(t.length,a.length))),r.resize()}).keydown(function(a){var s,o,g=n.getCharcode(a);t.each(i,function(t,e){if(g===e)return s=t,!1}),o=r.handleKeydown[s],o&&o.call(r,{event:a,caret:n.getCaretPos(e.tag_input[0]),old_val:e.tag_input.val(),prevTag:e.tag_writer.prev(".tag"),nextTag:e.tag_writer.next(".tag")})}),e.tag_editor.delegate(".tag a","click",function(e){e.preventDefault(),e.stopPropagation(),r.remove(t(this).parent(".tag").find("i").text())}).delegate(".tag","click",function(i){var n=t(this).find("i").text();r.get(r.indexOf(n)).editable(e),r.remove(n)})},handleKeydown:{BACKSPACE:function(t){if(0===t.caret){var e=this.getTag(t.prevTag);if(e>-1){var i=this.get(e);this.dom.tag_input.val(i.text+" "+this.dom.tag_input.val()),n.setCaretPos(this.dom.tag_input[0],i.text.length+1),this.remove(i.text)}this.resize()}},LEFT:function(t){if(0===t.caret){var e=this.getTag(t.prevTag);if(e>-1){var i=this.get(e);this.dom.tag_writer.addClass("small-tags-writer").width(t.prevTag.outerWidth()).after(t.prevTag),this.dom.tag_input.val(i.text),this.remove(i.text),this.insert(t.old_val,"after")}this.resize()}},RIGHT:function(t){if(t.caret===t.old_val.length&&t.nextTag.length){var e=this.getTag(t.nextTag);if(e>-1){var i=this.get(e);this.dom.tag_writer.width(t.nextTag.outerWidth()).before(t.nextTag),this.dom.tag_input.val(i.text),this.remove(i.text),this.renderFromString(t.old_val)}n.setCaretPos(this.dom.tag_input[0],0),this.resize()}},HOME:function(t){this.dom.tag_input.blur(),this.get(0)&&(this.get(0).editable(this.dom),this.remove(this.get(0).text))},END:function(t){this.dom.tag_input.blur(),this.get(-1)&&(this.get(-1).editable(this.dom),this.remove(this.get(-1).text))},A:function(e){if(e.event.ctrlKey){var i=this.dom.tag_input.val(),n=this.dom.tag_writer.prevAll(".tag").find("i").map(function(e,i){return t(i).text()}).get().reverse();t.trim(i)&&n.push(i),t.merge(n,this.dom.tag_writer.nextAll(".tag").find("i").map(function(e,i){return t(i).text()}).get()),this.dom.tag_input.val(n.join(",")),this.resize(),this.removeAllTags()}}}},t.fn.TagEditor=function(i){return this.pushStack(this.map(function(){return new a(t(this),t.extend(e,i||{}))}))}}(jQuery);