!function(t){function i(i,e){function a(i){t.contains(n.dialog.node[0],i.target)||n.close()}var o=i.html(),n=this,d={title:"",cls:"",autoClose:!1,multi:!1,url:"",param:{},callback:{}},l=t.extend({},d,e);this._multi=l.multi,this.dialog=dui.Dialog({title:l.title,cls:l.cls,width:500,content:o},l.multi),this.dialog.node.addClass("dialog-tags"),this.tagEditor={},n._initDialogFrm(l.url,l.param,l.callback),l.autoClose&&t("body").bind("click",a),n.dialog.node.bind("dialog:close",function(){n._multi&&n.removeDialog(),t("body").unbind("click",a)})}i.prototype={_initDialogFrm:function(i,e,a){var o=(this.dialog.node.find("form"),this.dialog.node.find('[type="submit"]')),n=this.dialog.node.find(".tag-editor-bd"),d=this,l="";d.tagEditor=n.TagEditor().get(0),d._extendTagEditor(n),d.tagEditor.on("plugin:expand error error:hidden",function(){d.dialog.update()}),n.find(".tags-folder span:gt(5)").length||(n.find(".tags_more").hide(),d.dialog.update()),o.click(function(n){n.preventDefault(),l=d.tagEditor.plainString(),t.isFunction(a)?a.call(d,l):i&&(o.attr("disabled","disabled").addClass("bn-disable").val("提交中…"),t.post_withck(i,t.extend({author_tags:l},e),function(){o.removeAttr("disabled"),d.dialog.close(),document.location.reload()},"POST"))})},_extendTagEditor:function(i){var e=t(".tags-tip",i),a=t(".tags-folder span",i),o=t(".tags-control",i),n=t(".tags-folder",i),d=this.tagEditor;d.on("error",function(t,i){switch(i.type){case"exist":var a=d.taglist[i.msg].node;a.addClass("tags-warn"),setTimeout(function(){a.removeClass("tags-warn")},1e3),d.dom.tag_input.val("");break;default:!e.is(":visible")&&e.text(i.msg).fadeIn().delay(2e3).fadeOut(function(){d.fire("error:hidden")})}}).on("change",function(i){var e=d.dom.tag_writer.find("label");a.each(function(i,e){e=t(e),d.indexOf(e.text())>-1?e.addClass("tag-selected"):e.removeClass("tag-selected")}),d.taglist.length?e.addClass("invisible"):e.removeClass("invisible")}),o.delegate(".tags_more","click",function(i){i.preventDefault(),n.addClass("tags-unfold"),d.fire("plugin:expand"),t(this).hide()}),n.delegate("span","click",function(){var i=t(this);i.hasClass("tag-selected")?d.remove(i.text()):d.insert(i.text())}),d.dom.tag_writer.find("label").removeClass("invisible")},show:function(t,i,e,a,o){var n=this,d=[];if(i&&(n.tagEditor.removeAllTags(),n.tagEditor.renderFromString(i)),n.dialog.open(),t&&n.dialog.setTitle(t).update(),e&&a){var l=n.dialog.node;o&&"right"===o&&(d[0]=a[0]-l.width()+parseInt(l.find(".dui-dialog-shd").css("left"),10)+a[2]),(!d[0]||d[0]<0)&&(d[0]=a[0]-parseInt(l.find(".dui-dialog-shd").css("left"),10)),d[1]=a[1]-l.height()-22,n.dialog.set({isStick:e,position:d})}return this},close:function(){return this.dialog.close(),this._multi&&this.removeDialog(),this},removeDialog:function(){return this.dialog.node.remove(),this}},t.fn.TagEditorDialog=function(t,e){return new i(t,e)}}(jQuery);